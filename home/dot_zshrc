# =============
# Core Settings
# =============
# History
HISTFILE="$XDG_STATE_HOME/zsh/history"
HISTSIZE=10000
HISTDUP=erase
SAVEHIST=10000
setopt HIST_IGNORE_DUPS     # Don't record duplicated commands
setopt HIST_REDUCE_BLANKS   # Remove unnecessary blanks
setopt INC_APPEND_HISTORY   # Add commands to history immediately
setopt EXTENDED_HISTORY     # Record command start time
setopt SHAREHISTORY         # Share history between shells
setopt HIST_IGNORE_ALL_DUPS # Pretty much self explanatory...
setopt HIST_FIND_NO_DUPS

# General
unsetopt beep
setopt AUTO_CD       # Allow changing directories without cd
setopt EXTENDED_GLOB # Extended globbing
setopt NOTIFY        # Report status of background jobs immediately
setopt PROMPT_SUBST  # Enable prompt substitution

# =================
# Key Bindings
# =================
bindkey -e                                       # Emacs key bindings
bindkey '^[[A' history-beginning-search-backward # Up arrow
bindkey '^[[B' history-beginning-search-forward  # Down arrow
bindkey '^[[H' beginning-of-line                 # Home key
bindkey '^[[F' end-of-line                       # End key
bindkey '^[[3~' delete-char                      # Delete key
bindkey '^p' history-search-backward             # Search history for the related command backward
bindkey '^n' history-search-forward              # Search history for the related command forward

# =================
# Completion System
# =================
zstyle ':completion:*' menu no                        # Enable menu selection
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' # Case insensitive completion
zstyle ':completion:*' special-dirs true                  # Complete special directories
zstyle ':completion:*' list-colors ''                     # Colored completion
zstyle ':completion:*' verbose yes                        # Verbose completion messages
zstyle ':completion:*git-checkout:*' sort false   				# Disable sort when completing `git checkout`
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS} 		# Set list-colors to enable filename colorizing
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath' # Preview directory's content with eza when completing cd
# zstyle ':fzf-tab:*' fzf-command ftb-tmux-popup # Use tmux pop-up feature for fzf
zstyle ':compinstall filename' '/home/raiden/.zshrc'

fpath=(~/.config/zsh/completion $fpath)
autoload -Uz compinit && compinit
compinit -d "$XDG_CACHE_HOME"/zsh/zcompdump-"$ZSH_VERSION"

# =================
# Custom Functions
# =================

function wiki() {
    firefox --new-tab https://wiki.archlinux.org/title/Special:Search/"$@"
}
function ls() {
    eza -i "$@" --icons=auto
}

function nvim() {
    $HOME/.config/hypr/scripts/kitty_nvim.sh "$@"
}

function sk() {
    QT_QPA_PLATFORM=xcb sioyek "$@"
}

function open() {
    xdg-open "$@"
}

function open-background() {
    "$@" &>/dev/null & disown
}

function runc() {
    gcc -g -Wall -O "$@" -o bin/file.o && ./bin/file.o
}

function y() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
    yazi "$@" --cwd-file="$tmp"
    IFS= read -r -d '' cwd < "$tmp"
    [ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
    rm -f -- "$tmp"
}

function cze() {
    if [ $# -eq 0 ]; then
        chezmoi edit
    else
        setopt local_options EXTENDED_GLOB
        chezmoi edit "$@"
    fi
}

function cza() {
    if [ $# -eq 0 ]; then
        chezmoi apply
    else
        setopt local_options EXTENDED_GLOB
        chezmoi apply
    fi
}

# Chezmoi EditConf
function czec() {
    nvim $HOME/.local/share/chezmoi/ansible/group_vars/all.yml
}

function start_tmux() {
    if [[ "$TMUX" == "" ]]; then
        tmux;
    fi
}

compdef _chezmoi cze
compdef _chezmoi cza
compdef _chezmoi czec

[ -f ~/.zshrc_external_func.zsh ] && source ~/.zshrc_external_func.zsh

# =================
# Mimetype handling
# =================

if [[ $XDG_CURRENT_DESKTOP == *niri* ]]; then
    export XDG_DATA_DIRS="$HOME/.local/share/applications/niri:$XDG_DATA_DIRS"
    [ -f ~/.config/niri/mimeapps.list ] && ln -sf ~/.config/niri/mimeapps.list ~/.config/mimeapps.list
fi

if [[ $XDG_CURRENT_DESKTOP == *kde* ]]; then
    export XDG_DATA_DIRS="$HOME/.local/share/applications/kde:$XDG_DATA_DIRS"
    [ -f ~/.config/kde/mimeapps.list ] && ln -sf ~/.config/kde/mimeapps.list ~/.config/mimeapps.list
fi

if [[ $XDG_CURRENT_DESKTOP == *hypr* ]]; then
    export XDG_DATA_DIRS="$HOME/.local/share/applications/hypr:$XDG_DATA_DIRS"
    [ -f ~/.config/hypr/env/mimeapps.list ] && ln -sf ~/.config/hypr/env/mimeapps.list ~/.config/mimeapps.list
fi

# =================
# MPD Starting
# =================

if ! [[ -d "$XDG_RUNTIME_DIR/mpd" ]]; then
    mkdir "$XDG_RUNTIME_DIR/mpd"
fi

# =================
# Aliases
# =================
# Additional useful aliases
alias l='eza -l -i --icons=auto --git'
alias ll='eza -l -i --icons=auto'
alias la='eza -la -i --icons=auto'
alias grep='grep --color=auto'
alias mkdir='mkdir -p'
alias cp='cp -i' # Confirm before overwriting
alias mv='mv -i' # Confirm before overwriting
alias rm='rm -i' # Confirm before removing
alias ytdl='yt-dlp --write-description --embed-metadata -o "./%(uploader)s/%(title)s.%(ext)s"'
alias ytdl-music='yt-dlp --write-description --extract-audio --audio-format best --embed-thumbnail --embed-metadata -o "./%(uploader)s/%(title)s.%(ext)s"'
alias ytdl-music-video='yt-dlp --write-description --audio-format best --embed-thumbnail --embed-metadata -o "./%(uploader)s/%(title)s.%(ext)s"'
alias ytdl-archive='yt-dlp --download-archive "./.download_history.txt" --write-description --embed-metadata --min-sleep-interval 15 --max-sleep-interval 30 -o "./%(uploader)s/%(title)s.%(ext)s"'
alias ytdl-music-archive='yt-dlp --download-archive "./.download_history.txt" --write-description --min-sleep-interval 15 --max-sleep-interval 30 --extract-audio --audio-format best --embed-thumbnail --embed-metadata -o "./%(uploader)s/%(title)s.%(ext)s"'
alias move='sudo rsync -aP --remove-source-files'
alias bb='nvim ~/Documents/Programming/Toolbox/cheatsheet/pure-bash-bible/README.md'
alias vscode-fonts-list="fc-list | awk -F: '{print \$2}' | sort | uniq"

# Aliases handling for respecting XDG standards
alias wget="wget --hsts-file=$XDG_DATA_HOME/wget-hsts"
alias adb='HOME="$XDG_DATA_HOME"/android adb'

# =================
# Environment
# =================

export EDITOR="$HOME/.config/hypr/scripts/kitty_nvim.sh"
export PATH="$PATH:$HOME/.config/zsh/.antidote:$HOME/.local/bin:$HOME/.cargo/bin/:$HOME/.local/share/JetBrains/Toolbox/scripts"
export STARSHIP_CONFIG="$HOME/.config/starship/starship.toml"
export CRYPTOGRAPHY_OPENSSL_NO_LEGACY=1
export AUR_PAGER='yazi'
export MANPAGER='nvim +Man!'
export GOPATH="$HOME/Documents/Programming/Toolbox/languages/go/packages"
export MPD_HOST="$XDG_RUNTIME_DIR/mpd/socket" # Allows to connect to MPD server for Music

# Environment variables to respect XDG standards
export ANDROID_USER_HOME="$XDG_DATA_HOME"/android
export ANSIBLE_HOME="$XDG_DATA_HOME"/ansible
export CARGO_HOME="$XDG_DATA_HOME"/cargo
export CUDA_CACHE_PATH="$XDG_CACHE_HOME"/nv
export DOTNET_CLI_HOME="$XDG_DATA_HOME"/dotnet
export DOT_SAGE="$XDG_CONFIG_HOME"/sage
export GRADLE_USER_HOME="$XDG_DATA_HOME"/gradle
export GTK2_RC_FILES="$XDG_CONFIG_HOME"/gtk-2.0/gtkrc
export NPM_CONFIG_CACHE="$XDG_CACHE_HOME"/npm
export NPM_CONFIG_INIT_MODULE="$XDG_CONFIG_HOME"/npm/config/npm-init.js
export NPM_CONFIG_TMP="$XDG_RUNTIME_DIR"/npm
export NUGET_PACKAGEs="$XDG_CACHE_HOME"/NuGetPackages
export OMNISHARPHOME="$XDG_CONFIG_HOME"/omnisharp
export RUSTUP_HOME="$XDG_DATA_HOME"/rustup
export TEXMFVAR="$XDG_CACHE_HOME"/texlive/textmf-var
export WINEPREFIX="$XDG_DATA_HOME"/wine

# =================
# Tool Integration
# =================

# Auto-switch mimetypes based on current desktop environment
if [ "$XDG_CURRENT_DESKTOP" = "KDE" ]; then
    export XDG_DATA_DIRS="$HOME/.local/share/applications/kde:$XDG_DATA_DIRS"
    [ -f ~/.config/kde/mimeapps.list ] && ln -sf ~/.config/kde/mimeapps.list ~/.config/mimeapps.list
elif [ "$XDG_CURRENT_DESKTOP" = "Hyprland" ]; then
    export XDG_DATA_DIRS="$HOME/.local/share/applications/hyprland:$XDG_DATA_DIRS"
    [ -f ~/.config/hypr/configs/mimeapps.list ] && ln -sf ~/.config/hypr/configs/mimeapps.list ~/.config/mimeapps.list
fi

# Initialize fzf
source <(fzf --zsh)

# Load antidote package manager
zstyle ':antidote:bundle' file "$HOME/.config/antidote/.zsh_plugins.txt"
source "$HOME/.config/antidote/antidote.zsh"
antidote load "${ZDOTDIR:-$HOME/.config/antidote}/.zsh_plugins.txt"

# Start uwsm at tty1 for login
if [ "$(tty)" = "/dev/tty1" ]; then
    if uwsm check may-start && uwsm select; then
        exec systemd-cat -t uwsm_start uwsm start default
    fi
fi

# Initialize zoxide (smarter cd)
eval "$(zoxide init zsh --cmd cd)"

# Initialize starship prompt (load last to ensure proper prompt initialization)
eval "$(starship init zsh)"

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/home/raiden/.local/share/miniforge3/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/home/raiden/.local/share/miniforge3/etc/profile.d/conda.sh" ]; then
        . "/home/raiden/.local/share/miniforge3/etc/profile.d/conda.sh"
    else
        export PATH="$PATH:/home/raiden/.local/share/miniforge3/bin"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<


# >>> mamba initialize >>>
# !! Contents within this block are managed by 'mamba shell init' !!
export MAMBA_EXE='/home/raiden/.local/share/miniforge3/bin/mamba';
export MAMBA_ROOT_PREFIX='/opt/miniforge';
__mamba_setup="$("$MAMBA_EXE" shell hook --shell zsh --root-prefix "$MAMBA_ROOT_PREFIX" 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__mamba_setup"
else
    alias mamba="$MAMBA_EXE"  # Fallback on help from mamba activate
fi
unset __mamba_setup
# <<< mamba initialize <<<

start_tmux
